
# Links: 
# https://github.com/itzg/docker-minecraft-server
# https://help.github.com/en/actions/configuring-and-managing-workflows/about-service-containers
# https://help.github.com/en/actions/configuring-and-managing-workflows/creating-postgresql-service-containers
# https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idservices
# https://github.com/itzg/mc-monitor
# https://github.com/actions/example-services/blob/master/.github/workflows/redis-service.yml
# https://stackoverflow.com/questions/57549439/how-do-i-use-docker-with-github-actions

# https://dev.to/s_abderemane/how-to-use-docker-services-in-github-actions-6ce
# https://github.com/peter-evans/docker-compose-actions-workflow
# https://github.community/t5/GitHub-Actions/Github-Actions-services-not-reachable/td-p/30050
# https://docs.docker.com/engine/reference/commandline/create/#options
# https://github.com/itzg/docker-minecraft-server/blob/master/examples/docker-compose-forge.yml
# https://docs.docker.com/compose/compose-file/
# https://ryaneschinger.com/blog/using-docker-native-health-checks/
# https://github.com/laradock/laradock/blob/master/docker-compose.yml
# https://testdriven.io/blog/deploying-django-to-digitalocean-with-docker-and-github-actions/
# https://github.com/peter-evans/docker-compose-healthcheck
# https://ryaneschinger.com/blog/using-docker-native-health-checks/

on: [push]

jobs:
  download_mod:
    name: Download mod
    runs-on: ubuntu-latest
    steps:
    
      - name: Checkout
        id: checkout_source
        uses: actions/checkout@v2

      - name: Display the path
        id: pwd_path
        run: pwd

      - name: Show processes and ports
        id: show_ports
        run: netstat -plnt

      - name: Display current directory
        id: ls_path
        run: ls -la

      - name: Create mods dir
        id: mkdir_data
        run: mkdir $GITHUB_WORKSPACE/mods

      - name: Download mod
        id: download_mod
        run: wget -P $GITHUB_WORKSPACE/mods https://github.com/athrane/bassebombecraft/releases/download/1.42.1/BasseBombeCraft-1.15.2-1.42-server.jar

      - name: Display the mod directory
        id: ls_mod_dir
        run: ls -la $GITHUB_WORKSPACE/mods

      - name: Start container 
        id: start_container
        run: docker-compose up -d

      - name: List containers 
        id: list_containers
        run: docker ps -a

      - name: Get Minecraft container health
        id: mc_container_health
        run: docker container inspect -f "{{.State.Health.Status}}" minecraftserver

      - name: Display Minecraft container logs
        id: mc_container_logs
        run: docker logs minecraftserver

  test_mod:
    name: Test mod in server 
    needs: download_mod
    runs-on: ubuntu-latest
    timeout-minutes: 5
    services:
      mcserver:
        image: itzg/minecraft-server:multiarch      
        env:
          NAME: mc
          EULA: TRUE
          VERSION: 1.15.2
          TYPE: FORGE
          FORGEVERSION: 31.1.10
        ports:
          - 25565:25565
        volumes:
           - mods:/mods
        options: --name minecraftserver

    steps:    
      - name: Get Minecraft container health
        id: mc_container_health
        run: /usr/bin/docker container inspect -f "{{.State.Health.Status}}" minecraftserver

      - name: Display Minecraft container logs
        id: mc_container_logs
        run: /usr/bin/docker logs minecraftserver

      - name: Display the mod directory
        id: ls_mod_dir
        run: ls -la $GITHUB_WORKSPACE/mods
        shell: bash

