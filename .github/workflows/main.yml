
# Links: 
# https://github.com/itzg/docker-minecraft-server
# https://help.github.com/en/actions/configuring-and-managing-workflows/about-service-containers
# https://help.github.com/en/actions/configuring-and-managing-workflows/creating-postgresql-service-containers
# https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idservices
# https://github.com/itzg/mc-monitor
# https://github.com/actions/example-services/blob/master/.github/workflows/redis-service.yml
# https://stackoverflow.com/questions/57549439/how-do-i-use-docker-with-github-actions

# https://dev.to/s_abderemane/how-to-use-docker-services-in-github-actions-6ce
# https://github.com/peter-evans/docker-compose-actions-workflow
# https://github.community/t5/GitHub-Actions/Github-Actions-services-not-reachable/td-p/30050
# https://docs.docker.com/engine/reference/commandline/create/#options
# https://github.com/itzg/docker-minecraft-server/blob/master/examples/docker-compose-forge.yml
# https://docs.docker.com/compose/compose-file/
# https://ryaneschinger.com/blog/using-docker-native-health-checks/
# https://github.com/laradock/laradock/blob/master/docker-compose.yml
# https://testdriven.io/blog/deploying-django-to-digitalocean-with-docker-and-github-actions/
# https://github.com/peter-evans/docker-compose-healthcheck
# https://ryaneschinger.com/blog/using-docker-native-health-checks/
# https://www.datanovia.com/en/courses/docker-compose-wait-for-dependencies/

# https://project-awesome.org/sdras/awesome-actions#collection-of-actions
# https://github.com/jakejarvis/wait-action
# https://github.com/Eficode/wait-for
# https://github.com/vishnubob/wait-for-it
# https://docs.docker.com/compose/startup-order/
# https://hub.docker.com/r/itzg/minecraft-server/dockerfile/

# https://www.edwardthomson.com/blog/github_actions_9_deploy_to_github_packages.html
# https://dev.to/kenessajr/deploy-a-react-app-to-digitalocean-using-github-actions-and-docker-4pln
# https://github.community/t5/GitHub-Actions/Cache-a-Docker-image-built-in-workflow/td-p/31805
# https://github.com/marketplace/actions/build-docker-images-using-caches

# Building with buildkit to avoid issues 3639
# https://github.com/moby/moby/issues/3639
# https://qiita.com/homines22/items/6d28461d97906e42f57c
# https://github.com/docker/github-actions/blob/826b584752ffa6abc1a2d94da26f348e3e4f73d0/.github/workflows/main.yml#L27

on: [push]

jobs:
  create_container:
    name: Create container with mod
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1    
    steps:
    
      - name: Checkout
        uses: actions/checkout@v2

      - name: Display the path
        run: pwd

      - name: Show processes and ports
        run: netstat -tulpn

      - name: Display current directory
        run: ls -la

      - name: Docker login
        run: docker login -u thrane -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Build image
        run: docker build . --file Dockerfile --tag bassebombecraft/minecraft:${{ github.sha }} --tag bassebombecraft/minecraft:latest

      - name: Push image
        run: docker push bassebombecraft/minecraft:${{ github.sha }}

      - name: Push image
        run: docker push bassebombecraft/minecraft:latest

  test_mod:
    name: Test mod in server 
    needs: create_container
    runs-on: ubuntu-latest
    timeout-minutes: 5
    services:
      mcserver:
        image: bassebombecraft/minecraft:latest
        ports:
          - 25565:25565
        options: --name minecraftserver

    steps:    
      - name: Get Minecraft container health
        run: /usr/bin/docker container inspect -f "{{.State.Health.Status}}" minecraftserver

      - name: Display Minecraft container logs
        run: /usr/bin/docker logs minecraftserver

